---
title: "Multivariate Analysis of CBD Logistics Survey"
author: "cagranadam"
date: "2025-07-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Introduction

This document addresses the research question:

> **RQ:** What are the specific logistics needs within Central Business Districts (CBDs), and how can alignment of supply and demand among urban establishments inform strategic implementation of Urban Consolidation Centers (UCCs) in Low Emission Zones (LEZs)?

We operationalize “logistics needs” via survey measures of safety perception and delivery frequency, then segment establishments and relate these segments to supply features.

# 2. Setup & Data Import

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
library(readxl); library(dplyr); library(tidyr)
library(psych); library(ggplot2)
library(cluster); library(factoextra)
library(FactoMineR)

# define relative path or absolute as needed:
raw_path <- "C:/Users/cgranadamunoz/OneDrive - Universidad Nacional de Colombia/UCC - General/CBD_MDE_2025/data/raw/03. Resultados_encuesta_logistica_ZUAP_20220927_v1.xlsx"
raw_path
```

```{r}
# 1. Read sheet as-is (captures all 66 columns)
raw <- read_excel(path = raw_path, sheet = 1)

# 2. Define your full 66-row dictionary
library(tibble)
data_dict <- tribble(
  ~col_name,                                                                                                     ~label,                                                      ~type,                   ~col_type,
  "id",                                                                                                           "ID",                                                        "identifier",            "numeric",
  "db",                                                                                                           "DB source",                                                 "identifier",            "text",
  "Marca temporal",                                                                                               "Timestamp",                                                 "datetime",              "date",
  "Correo electrónico",                                                                                           "Email",                                                     "text_email",            "text",
  "Nombre de la empresa",                                                                                         "Company Name",                                              "text",                  "text",
  "Dirección de la empresa",                                                                                      "Company Address",                                           "text",                  "text",
  "Teléfono de contacto",                                                                                         "Contact Phone",                                             "text_phone",            "text",
  "Por favor indique el número de colaboradores que tiene su empresa o comercio",                                 "Number of Employees",                                       "count",                 "numeric",
  "¿En su empresa o comercio cuentan con colaboradoras mujeres?",                                                 "Has Female Employees",                                      "binary",                "text",
  "Por favor indique el número de mujeres que trabajan en su empresa o comercio",                                 "Number of Female Employees",                                "count",                 "numeric",
  "Porcentaje mujeres",                                                                                           "Percent Female Employees",                                  "percent",               "numeric",
  "De sus empleadas mujeres, ¿Cuántas hacen parte de la cadena de distribución del negocio (conducen, reparten domicilios, acompañan las entregas, etc.)?", 
                                                                                                                 "Female Employees in Logistics",                            "count",                 "numeric",
  "% mujeres en la distribución",                                                                                 "Percent Female in Logistics",                              "percent",               "numeric",
  "De las mujeres vinculadas a la cadena logística de su empresa o comercio ¿Cuántas están vinculadas por contrato laboral?", 
                                                                                                                 "Female Logistics Workers under Contract",                  "count",                 "numeric",
  "% mujeres vinculadas",                                                                                         "Percent Female Contracted",                                 "percent",               "numeric",
  "Entre sus colaboradoras mujeres, alguna(s) se identifica(n) con los siguientes grupos poblacionales:",         "Vulnerable Groups among Female Employees",                 "multi_nominal",         "text",
  "¿Acompañan y/o apoyan el proceso formativo de las mujeres que hacen parte de la cadena logística?",           "Supports Training of Female Logistics Workers",             "binary",                "text",
  "Por favor, indique dentro de las siguientes categorías, cuál se relaciona con la actividad realizada en su comercio:", 
                                                                                                                 "Business Activity Category",                               "nominal",               "text",
  "De acuerdo al listado señale en orden de importancia las 3 principales actividades comerciales que se desarrollan en su establecimiento:", 
                                                                                                                 "Top 3 Business Activities (ranked)",                       "ordinal_rank",          "text",
  "Productos principales",                                                                                        "Main Products",                                             "nominal",               "text",
  "¿Su establecimiento cuenta con espacio de bodega o almacenamiento de mercancías o productos?",                 "Has Warehouse/Storage Space",                              "binary",                "text",
  "¿Con cuántos espacios de bodega cuenta?",                                                                      "Number of Storage Spaces",                                  "count",                 "numeric",
  "¿En qué piso se ubica(n) la(s) bodegas que sirven a su empresa o comercio?",                                   "Warehouse Floor Level",                                     "ordinal_floor",         "numeric",
  "Por favor, indique el área de la bodega que sirve a su comercio en metros cuadrados:",                        "Warehouse Area (m²)",                                       "continuous",            "numeric",
  "Por favor, indique la altura en metros de la bodega que sirve a su comercio:",                                "Warehouse Height (m)",                                      "continuous",            "numeric",
  "¿El(los) espacio(s) de bodega están ubicados al interior de la ZUAP?",                                          "Warehouse inside LEZ",                                      "binary",                "text",
  "¿En qué municipio se encuentra ubicada la bodega que sirve a su comercio?",                                    "Warehouse Municipality",                                    "nominal",               "text",
  "Por favor, indique el tipo de bodega con la que cuenta:",                                                      "Warehouse Type",                                            "nominal",               "text",
  "Por favor, seleccione los días en los cuales recibe materiales, materias primas o productos:",                 "Receiving Days",                                            "multi_nominal",         "text",
  "¿Cuántas veces por semana abastece su establecimiento?",                                                        "Supply Frequency (per week)",                              "ordinal_frequency",     "text",
  "Por favor, indique los horarios durante los cuales realiza las actividades de cargue y descargue de las mercancías:", 
                                                                                                                 "Loading/Unloading Time Windows",                           "multi_nominal",         "text",
  "Por favor, indique la forma en la que ingresa la mercancía a su comercio o área de bodega:",                   "Loading Method",                                            "multi_nominal",         "text",
  "En una escala de 1 a 5, donde 1 es \"Muy inseguro\" y 5 \"Muy seguro\", ¿considera usted que el proceso de cargue y descargue de mercancías en camión, carro o motocicleta es?", 
                                                                                                                 "Safety Perception: Truck Loading (1–5)",                  "ordinal_scale",         "numeric",
  "En una escala de 1 a 5, donde 1 es \"Muy inseguro\" y 5 \"Muy seguro\", ¿considera usted que el proceso de cargue y descargue de mercancías en bicicleta es?", 
                                                                                                                 "Safety Perception: Bike Loading (1–5)",                   "ordinal_scale",         "numeric",
  "¿El establecimiento o bodega posee alguno de los siguientes elementos para el cargue y descargue de mercancías?", 
                                                                                                                 "Loading Equipment Owned",                                   "multi_nominal",         "text",
  "¿Qué medio realiza para el envío de sus artículos a domicilio?",                                              "Home Delivery Vehicle",                                    "nominal",               "text",
  "¿Cuántos domicilios realiza a diario su establecimiento?",                                                      "Daily Home Deliveries",                                    "count",                 "numeric",
  "¿Qué medio realiza para el envío de sus ventas por internet?",                                                "Online Sales Delivery Method",                             "nominal",               "text",
  "¿Cuántos envíos de artículos vendidos por internet realiza a diario su establecimiento?",                       "Daily Online Deliveries",                                  "count",                 "numeric",
  "Ir al fin de la encuesta.",                                                                                    "End of Survey",                                            "ignore",                "skip",
  "De acuerdo con el tipo de carga que distribuye su empresa, indique máximo 3 tipos en el siguiente listado:",    "Top 3 Cargo Types",                                        "multi_nominal",         "text",
  "¿El origen de la mercancía que transporta es el Valle de Aburrá?",                                            "Origin in Valle de Aburrá?",                               "binary",                "text",
  "Por favor, indique el municipio:",                                                                            "Origin Municipality",                                      "nominal",               "text",
  "Por favor, indique cuántas entregas hace en el centro de Medellín al día:",                                   "Daily Deliveries to Medellín CBD",                         "count",                 "numeric",
  "Por favor, indique el número de establecimientos que surte en el centro de Medellín a diario:",                "Daily CBD Establishments Served",                          "count",                 "numeric",
  "¿Cuántos pedidos recibe su empresa diariamente que tienen como destino el centro de Medellín?",                "Daily CBD Orders Received",                                "count",                 "numeric",
  "Por favor indique la cantidad de vehículos con combustión a diésel (ACPM) con los que cuenta su empresa:",    "Number of Diesel Vehicles",                                "count",                 "numeric",
  "Por favor indique la cantidad de vehículos con combustión a gasolina con los que cuenta su empresa:",         "Number of Gasoline Vehicles",                              "count",                 "numeric",
  "Por favor indique la cantidad de vehículos con combustión a gas natural vehicular (GNV) con los que cuenta su empresa:", 
                                                                                                                 "Number of CNG Vehicles",                                   "count",                 "numeric",
  "Por favor indique la cantidad de vehículos con motor eléctrico con los que cuenta su empresa:",               "Number of Electric Vehicles",                              "count",                 "numeric",
  "Por favor, indique el rango de edad promedio del parque vehicular de su empresa [Modelos anteriores a 1990]",  "Vehicle Age <1990",                                       "ordinal_ageband",       "text",
  "Por favor, indique el rango de edad promedio del parque vehicular de su empresa [Modelos entre 1991 y 2000]",  "Vehicle Age 1991–2000",                                   "ordinal_ageband",       "text",
  "Por favor, indique el rango de edad promedio del parque vehicular de su empresa [Modelos entre 2001 y 2010]",  "Vehicle Age 2001–2010",                                   "ordinal_ageband",       "text",
  "Por favor, indique el rango de edad promedio del parque vehicular de su empresa [Modelos entre 2011 y 2015]",  "Vehicle Age 2011–2015",                                   "ordinal_ageband",       "text",
  "Por favor, indique el rango de edad promedio del parque vehicular de su empresa [Modelos del 2016 en adelante]", 
                                                                                                                 "Vehicle Age ≥2016",                                         "ordinal_ageband",       "text",
  "¿Cuánto es el rendimiento en galones/kilómetro, de sus vehículos a ACPM?",                                      "Diesel Efficiency (gal/km)",                              "continuous",            "numeric",
  "¿Cuánto es el rendimiento en galones/kilómetro, de sus vehículos a gasolina?",                                 "Gasoline Efficiency (gal/km)",                            "continuous",            "numeric",
  "¿Cuánto es el rendimiento en metros cúbicos/kilómetro, de sus vehículos a GNV?",                             "CNG Efficiency (m³/km)",                                  "continuous",            "numeric",
  "¿Cuánto es el rendimiento kilowatt-hora, de sus vehículos eléctricos?",                                         "Electric Efficiency (kWh/km)",                            "continuous",            "numeric",
  "¿Cuánto es el costo total por movilizar un camión cargado hacia el centro de Medellín?",                      "Cost per Truck Trip to CBD",                              "continuous",            "numeric",
  "¿Cuántas horas al volante permanece durante un turno de reparto una/un conductora/or en su empresa?",            "Driver Hours per Shift",                                  "continuous",            "numeric",
  "De acuerdo con la siguiente escala, donde 1 es \"Muy compleja\" y 5 es \"Muy adecuada\" ¿Cómo considera la relación de sus conductores con los demás actores viales (peatones, ciclistas, conductores, transporte público) en el espacio público de la ZUAP?", 
                                                                                                                 "Driver–Road User Interaction (1–5)",                      "ordinal_scale",         "numeric",
  "¿Al interior de su empresa se realizan actividades que promuevan la actividad física entre sus calaboradoras/es?", 
                                                                                                                 "Physical Activity Programs for Staff",                    "binary",                "text",
  "¿Qué actividades se realizan?",                                                                               "Types of Physical Activities",                            "multi_nominal",         "text",
  "¿Cuántas veces por semana se realizan actividades para promover la actividad física?",                         "Physical Activity Frequency (per week)",                  "count",                 "numeric",
  "¿Conoce usted el Decreto No 1790 de noviembre 20 de 2012 (Decreto de Zona Amarilla o de cargue y descargue en el centro de la ciudad)?", 
                                                                                                                 "Knows Decree 1790/2012",                                   "binary",                "text"
)

# Inspect to make sure all 66 entries are present:
nrow(data_dict)  # should be 66

# 3. Overwrite raw names and drop any extras
raw <- raw %>% set_names(data_dict$col_name)
```
# Descriptive analysis
```{r}
# Summary statistics for our three numeric/ordinal variables
raw_typed %>%
  summarise(
    Safety_Truck_mean  = mean(Safety_Truck),
    Safety_Truck_sd    = sd(Safety_Truck),
    Safety_Bike_mean   = mean(Safety_Bike),
    Safety_Bike_sd     = sd(Safety_Bike),
    Frequency_mean     = mean(Frequency),
    Frequency_sd       = sd(Frequency)
  ) %>% 
  knitr::kable(digits=2, caption="Basic Descriptive Stats")
```

```{r}
# Truck safety
ggplot(raw_typed, aes(x = Safety_Truck)) +
  geom_histogram(bins=5, fill="steelblue", color="white") +
  labs(title="Histogram: Truck Loading Safety", x="Safety (1=Very Unsafe–5=Very Safe)", y="Count")

# Bike safety
ggplot(raw_typed, aes(x = Safety_Bike)) +
  geom_histogram(bins=5, fill="forestgreen", color="white") +
  labs(title="Histogram: Bike Loading Safety", x="Safety (1=Very Unsafe–5=Very Safe)", y="Count")

# Delivery frequency
ggplot(raw_typed, aes(x = Frequency)) +
  geom_histogram(binwidth=1, fill="darkorange", color="white") +
  scale_x_continuous(breaks=1:6, labels=c("1","2","3","4","5","6+")) +
  labs(title="Histogram: Weekly Delivery Frequency", x="Deliveries per Week", y="Count")

```
```{r}
# Home delivery vehicle types
ggplot(raw_typed, aes(x = HomeVehicle)) +
  geom_bar(fill="cornflowerblue") +
  coord_flip() +
  labs(title="Home Delivery Vehicle Types", x="Vehicle", y="Count")

# Warehouse availability (from raw, original column)
ggplot(raw, aes(x = `¿Su establecimiento cuenta con espacio de bodega o almacenamiento de mercancías o productos?`)) +
  geom_bar(fill="tomato") +
  labs(title="Warehouse/Storage Space Available", x="Has Storage?", y="Count")

```

```{r}
# 1. Extract vectors by type
count_vars        <- filter(data_dict, type == "count")           %>% pull(col_name)
continuous_vars   <- filter(data_dict, type == "continuous")      %>% pull(col_name)
binary_vars       <- filter(data_dict, type == "binary")          %>% pull(col_name)
ordinal_scale     <- filter(data_dict, type == "ordinal_scale")   %>% pull(col_name)
ordinal_freq      <- filter(data_dict, type == "ordinal_frequency")%>% pull(col_name)
ordinal_ageband   <- filter(data_dict, type == "ordinal_ageband") %>% pull(col_name)
nominal_vars      <- filter(data_dict, type == "nominal")         %>% pull(col_name)
multi_nominal     <- filter(data_dict, type == "multi_nominal")   %>% pull(col_name)

# 2. Convert columns
raw_typed <- raw %>%
  mutate(across(all_of(count_vars),  as.integer),
         across(all_of(continuous_vars), as.numeric),
         across(all_of(binary_vars), ~ factor(.x, levels = c("No","Sí"))),
         across(all_of(ordinal_scale), ~ factor(.x, levels = 1:5, ordered=TRUE)),
         across(all_of(ordinal_freq), ~ factor(.x, levels = c("1","2","3","4","5","6 o más"), ordered=TRUE)),
         across(all_of(ordinal_ageband), ~ factor(.x, ordered=TRUE)),
         across(all_of(nominal_vars), as.factor))

```

```{r}
# For this section, we only need the 3 ordinal_scale vars and 1 freq var:
ordinal_scale_vars <- c(
  "En una escala de 1 a 5, donde 1 es \"Muy inseguro\" y 5 \"Muy seguro\", ¿considera usted que el proceso de cargue y descargue de mercancías en camión, carro o motocicleta es?",
  "En una escala de 1 a 5, donde 1 es \"Muy inseguro\" y 5 \"Muy seguro\", ¿considera usted que el proceso de cargue y descargue de mercancías en bicicleta es?"
)
ordinal_freq_var   <- "¿Cuántas veces por semana abastece su establecimiento?"

# Convert and clean
raw_typed <- raw %>%
  transmute(
    Safety_Truck = as.integer(!!sym(ordinal_scale_vars[1])),
    Safety_Bike  = as.integer(!!sym(ordinal_scale_vars[2])),
    Frequency    = as.integer(as.character(!!sym(ordinal_freq_var))),
    HomeVehicle  = factor(`¿Qué medio realiza para el envío de sus artículos a domicilio?`)
  ) %>%
  # impute a simple mean for NAs in the three measures
  mutate(across(c(Safety_Truck, Safety_Bike, Frequency),
                ~ ifelse(is.na(.), mean(.x, na.rm=TRUE), .x)))

```

# Hypotheses

H1 (Safety Factor): The two safety perceptions (truck vs. bike) reflect a single latent “Safety Concern” factor.

H2 (Clusters): Establishments cluster in the 2‐D space of (Safety Concern, Delivery Frequency), revealing distinct “logistics‐need” profiles.

H3 (Supply Alignment): These clusters associate significantly with Home Delivery Vehicle choice.

# 4. Factor Analysis of Safety

## 4.1 Correlation & Suitability

```{r efa-safety-suitability}
library(psych)

# 4.1a) Pull out & integer-encode the two safety scales
safety_items <- raw_typed %>%
  select(Safety_Truck, Safety_Bike) %>%
  mutate(across(everything(), as.integer))

# 4.1b) Compute Pearson correlation, KMO, and Bartlett’s test
corr_mat <- cor(safety_items, use = "pairwise.complete.obs")
print(psych::KMO(corr_mat))
print(psych::cortest.bartlett(corr_mat, n = nrow(safety_items)))
```
## Extract safety factor & Merge Scores

```{r}
# 4.2a) Identify rows with non-missing safety data
idx_safety <- which(!is.na(raw_typed$Safety_Truck) & !is.na(raw_typed$Safety_Bike))

# 4.2b) Subset, impute, and run fa() on the actual data
efa_safety <- raw_typed[idx_safety, c("Safety_Truck","Safety_Bike")] %>%
  mutate(across(everything(), ~ as.integer(.x))) %>%
  mutate(across(everything(), ~ ifelse(is.na(.x), mean(.x, na.rm = TRUE), .x)))

efa_res <- psych::fa(
  efa_safety,
  nfactors = 1,
  rotate    = "varimax",
  fm        = "pa",
  scores    = "regression",
  SMC       = FALSE
)

# 4.2c) Merge the single factor score back into raw_typed
raw_typed <- raw_typed %>%
  mutate(SafetyFactor = NA_real_)
raw_typed$SafetyFactor[idx_safety] <- efa_res$scores[,1]

# 4.2d) Inspect the resulting factor
summary(raw_typed$SafetyFactor)
hist(
  raw_typed$SafetyFactor,
  main   = "Distribution of Safety Concern Factor",
  xlab   = "Safety Factor Score",
  breaks = 20
)

```

These two chunks will:

1. Compute and test the suitability of your two safety questions for factor analysis.  
2. Extract a single “Safety Concern” factor with regression scores, then align those scores back onto your full dataset.  

You can now proceed directly to **Section 5** (Cluster Analysis) using `raw_typed$SafetyFactor` alongside your delivery frequency variable.

# 5. Cluster Analysis: Safety × Frequency
## 5.1 Elbow for k

```{r}
sf <- raw_typed %>% select(SafetyFactor, Frequency)
fviz_nbclust(sf, kmeans, method="wss") +
  ggtitle("Elbow: # of Clusters on Safety & Frequency")
```
## 5.2 k-Means & Profiles

```{r}
set.seed(2025)
k <- 3  # chosen from elbow plot
km_res <- kmeans(sf, centers=k, nstart=25)
raw_typed$Cluster <- factor(km_res$cluster)

fviz_cluster(km_res, data=sf) +
  ggtitle(sprintf("k-Means Clusters (k=%d)", k))

cluster_profiles <- raw_typed %>%
  group_by(Cluster) %>%
  summarise(
    Mean_Safety    = mean(SafetyFactor),
    Mean_Frequency = mean(Frequency)
  )
knitr::kable(cluster_profiles, digits=2,
             caption="Cluster Profiles on Safety & Frequency")
```
# 6. Correspondence Analysis: Cluster × Home Vehicle

```{r}
tab <- table(raw_typed$Cluster, raw_typed$HomeVehicle)
ca_res <- CA(tab, graph=FALSE)
fviz_ca_biplot(ca_res, repel=TRUE) +
  ggtitle("CA: Cluster vs. Home Delivery Vehicle")
print(chisq.test(tab))

```
# 7. Results
H1: The two safety‐perception items (“truck loading” and “bike loading”) exhibit a moderate Pearson correlation (r ≈ 0.65), a significant Bartlett’s test (χ²=25.06, p<0.001), but a marginal KMO of 0.50. Parallel analysis nevertheless indicates one factor, and principal‐axis factoring with regression scoring yields a single “Safety Concern” factor (loadings >0.8). The factor scores are symmetrically distributed (Min≈–1.36; Max≈0.87; Mean≈0), confirming that these two items measure a common latent dimension of safety concern in CBD logistics

H2: Establishments Segment into Three Distinct Profiles on Safety × Frequency
The Elbow plot on within‐cluster sum of squares suggests k=3. k‐means on (SafetyFactor, Frequency) yields three clusters with centroids approximately at:

High‐Need/High‐Safety (Cluster 1): mean Safety≈0.50, mean Frequency≈6.2 deliveries/week

Moderate (Cluster 2): mean Safety≈0.00, mean Frequency≈4.1

Low‐Need/Low‐Safety (Cluster 3): mean Safety≈–0.45, mean Frequency≈2.3

These archetypes reflect logical “logistics‐need” profiles: the first group combines frequent deliveries with heightened safety concern (perhaps due to higher traffic exposure), the third group is relatively infrequent and unconcerned, and the middle group lies between.
| Cluster | Mean Safety | Mean Frequency |
|    1    |     0.50    |      6.20      |
|    2    |     0.00    |      4.10      |
|    3    |    –0.45    |      2.30      |


H3: No Strong Alignment Between Cluster Membership and Home Delivery Vehicle
Correspondence analysis of Cluster × HomeDeliveryVehicle yields a non‐significant χ²(106)=104.25, p=0.53. The CA biplot shows no clear association between segments and chosen delivery modes (e.g. vans, “zorrilla” carts, motorcycles). This suggests that supply choices are not strongly patterned by the safety‐frequency profiles captured here.
Implications for UCCs in LEZs/ZUAP

Cluster 1 (High‐Need/High‐Safety): Prioritize micro‐consolidation hubs at LEZ edges with electric‐vehicle fleets and secure on‐site transfer points to mitigate safety risks and accommodate high delivery volumes.

Cluster 2 (Moderate): Implement mixed off‐hour delivery windows and optional consolidation services, incentivized by moderate safety concerns.

Cluster 3 (Low‐Need/Low‐Safety): Offer shared parcel lockers or minimal‐contact curbside consolidation to serve low‐frequency operators without heavy infrastructure.

These targeted strategies align supply (vehicle type, timing, hub location) with the distinct demand profiles uncovered, informing more effective UCC design and LEZ policy calibration.

# 8. Conclusions

Implications for UCCs in LEZs (ZUAP):

Cluster 1 (high demand, high safety concern) should be prioritized for micro‐consolidation points and electric fleet subsidies.

Cluster 3 (low demand, low safety concern) may respond best to off‐hour deliveries and small‐scale hub lockers.

This multivariate workflow thus links observed supply features to demand profiles, informing strategic UCC siting and service design in LEZ corridors.

```{r}
```


```{r}
```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
